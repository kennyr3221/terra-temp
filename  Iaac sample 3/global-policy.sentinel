global policy {
  enforcement_mode = "hard mandatory"
}

resource "azurerm_policy_assignment" "policy_assignment" {
  name                 = "policy_assignment"
  scope                = azurerm_resource_group.project1_rg.id
  policy_definition_id = azurerm_policy_definition.project1_rg.id

  parameters = <<PARAMETERS
    {
      "tagName": {
        "value": "environment"
        {
      "tagName": {
        "value": "testing"
      },
      "tagValue": {
        "value": "production"
      }
    }
  PARAMETERS

  tags = local.tags
}

trace:
      blob-public-access-level-set-to-private.sentinel:26:1 = Rule "main"
        Description:
          #-------------------------------------------------------------
          Name:        blob-public-access-level-set-to-private.sentinel
          Category:    Data Management
          Provider:    hashicorp/azurerm
          Resource:    azurerm_storage_container
          Check:       container_access_type is "private"
          #-------------------------------------------------------------
          #Ensure that 'Public access level' is set to Private for blob
          #containers.
          #-------------------------------------------------------------

        Value:
          true

trace:
      trusted-microsoft-services-is-enabled.sentinel:44:1 = Rule "main"
        Description:
          #-------------------------------------------------------------
          Name:        trusted-microsoft-services-is-enabled.sentinel
          Category:    Data Management
          Provider:    hashicorp/azurerm
          Resource:    azurerm_storage_account
          Check:       network_rules.bypass is "AzureServices"
          #-------------------------------------------------------------
          #Ensure 'Trusted Microsoft Services' is enabled for Storage
          #Account access.
          #-------------------------------------------------------------

        Value:
          true

trace:
      default-network-access-rule-set-to-deny.sentinel:35:1 = Rule "main"
        Description:
          #-------------------------------------------------------------
          Name:        default-network-access-rule-set-to-deny.sentinel
          Category:    Data Management
          Provider:    hashicorp/azurerm
          Resource:    azurerm_storage_account
          Check:       network_rules.default_action is "Deny"
          #-------------------------------------------------------------
          #Ensure default network access rule for Storage Accounts is
          #set to deny.
          #-------------------------------------------------------------

        Value:
          true

      default-network-access-rule-set-to-deny.sentinel:11:1 = Rule "deny_undefined_network_rules"
        Value:
          true

      default-network-access-rule-set-to-deny.sentinel:17:1 = Rule "network_rules_default_action_is_deny"
        Value:
          true

trace:
      secure-transfer-required-is-enabled.sentinel:25:1 = Rule "main"
        Description:
         #-------------------------------------------------------------
          Name:        secure-transfer-required-is-enabled.sentinel
          Category:    Data Management
          Provider:    hashicorp/azurerm
          Resource:    azurerm_storage_account
          Check:       enable_https_traffic_only is true
          #-------------------------------------------------------------
          #Ensure that 'Secure transfer required' is set to Enabled.
          #-------------------------------------------------------------

        Value:
          true

      secure-transfer-required-is-enabled.sentinel:10:1 - Rule "enable_https_traffic_only_is_true"
        Value:
          true

trace:
      diagnostic-logs-enabled.sentinel:10:1 = Rule "main"
        Description:
          #-------------------------------------------------------------
          Name:        diagnostic-logs-enabled.sentinel
          Category:    Monitoring
          Provider:    hashicorp/azurerm
          Resource:    azurerm_monitor_diagnostic_setting
          Check:       logs are enabled
          #-------------------------------------------------------------
          #Ensure that diagnostic logs are enabled for key Azure resources.
          #-------------------------------------------------------------

        Value:
          true

trace:
      monitoring-alerts-configured.sentinel:15:1 = Rule "main"
        Description:
          #-------------------------------------------------------------
          Name:        monitoring-alerts-configured.sentinel
          Category:    Monitoring
          Provider:    hashicorp/azurerm
          Resource:    azurerm_monitor_metric_alert
          Check:       alerts are configured
          #-------------------------------------------------------------
          #Ensure that monitoring alerts are configured for critical resources.
          #-------------------------------------------------------------

        Value:
          true

trace:
      rbac-enforced.sentinel:20:1 = Rule "main"
        Description:
          #-------------------------------------------------------------
          Name:        rbac-enforced.sentinel
          Category:    Access Management
          Provider:    hashicorp/azurerm
          Resource:    azurerm_role_assignment
          Check:       role_definition_id is assigned
          #-------------------------------------------------------------
          #Ensure that Role-Based Access Control (RBAC) is enforced.
          #-------------------------------------------------------------

        Value:
          true

trace:
      mfa-required-for-admins.sentinel:30:1 = Rule "main"
        Description:
          -------------------------------------------------------------
          Name:        mfa-required-for-admins.sentinel
          Category:    Access Management
          Provider:    hashicorp/azurerm
          Resource:    azurerm_azuread_user
          Check:       mfa_enabled is true for admins
         # -------------------------------------------------------------
         # Ensure that Multi-Factor Authentication (MFA) is required for all administrative accounts.
         # -------------------------------------------------------------

        Value:
          true

trace:
      nsg-rules-configured.sentinel:25:1 = Rule "main"
        Description:
          -------------------------------------------------------------
          Name:        nsg-rules-configured.sentinel
          Category:    Network Security
          Provider:    hashicorp/azurerm
          Resource:    azurerm_network_security_group
          Check:       security_rules are configured properly
          #-------------------------------------------------------------
          #Ensure that Network Security Group (NSG) rules are configured and restrictive.
          #-------------------------------------------------------------

        Value:
          true

trace:
      vnet-peering-configured.sentinel:28:1 = Rule "main"
        Description:
          -------------------------------------------------------------
          Name:        vnet-peering-configured.sentinel
          Category:    Network Security
          Provider:    hashicorp/azurerm
          Resource:    azurerm_virtual_network_peering
          Check:       virtual_network_links are configured
          #-------------------------------------------------------------
          #Ensure that Virtual Network (VNet) peering is configured for secure and controlled communication between VNets.
          #-------------------------------------------------------------

        Value:
          true

trace:
      tde-enabled-for-sql-db.sentinel:32:1 = Rule "main"
        Description:
         # -------------------------------------------------------------
          Name:        tde-enabled-for-sql-db.sentinel
          Category:    Data Security
          Provider:    hashicorp/azurerm
          Resource:    azurerm_sql_database
          Check:       transparent_data_encryption is enabled
          #-------------------------------------------------------------
          #Ensure that Transparent Data Encryption (TDE) is enabled for SQL databases.
          #-------------------------------------------------------------

        Value:
          true

trace:
      soft-delete-purge-protection-key-vault.sentinel:36:1 = Rule "main"
        Description:
          #-------------------------------------------------------------
          Name:        soft-delete-purge-protection-key-vault.sentinel
          Category:    Data Security
          Provider:    hashicorp/azurerm
          Resource:    azurerm_key_vault
          Check:       soft_delete and purge_protection are enabled
          #-------------------------------------------------------------
          #Ensure that Soft Delete and Purge Protection are enabled for Key Vaults.
          #-------------------------------------------------------------

        Value:
          true

trace:
      resources-tagged.sentinel:40:1 = Rule "main"
        Description:
          #-------------------------------------------------------------
          Name:        resources-tagged.sentinel
          Category:    Resource Management
          Provider:    hashicorp/azurerm
          Resource:    azurerm_resource_group
          Check:       tags include "environment" and "cost_center"
          #-------------------------------------------------------------
          #Ensure that all resources are tagged with "environment" and "cost_center".
          #-------------------------------------------------------------

        Value:
          true
